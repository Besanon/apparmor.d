# apparmor.d - Full set of apparmor profiles
# Copyright (C) 2024 Alexandre Pujol <alexandre@pujol.io>
# SPDX-License-Identifier: GPL-2.0-only

# Minimal set of rules for bwrap

# A profile using this abstaction still needs to include: @{bin}/bwrap rix,

  capability net_admin,
  capability setpcap,
  capability sys_admin,
  capability sys_ptrace,

  network netlink raw,

  mount               options=(rw rbind)                          /oldroot/ -> /newroot/,
  mount               options=(rw rbind)            /oldroot/dev/{,u}random -> /newroot/dev/{,u}random,
  mount               options=(rw rbind)                      /tmp/newroot/ -> /tmp/newroot/,
  mount               options=(rw rbind)                   /oldroot/dev/tty -> /newroot/dev/tty,
  mount               options=(rw rbind)            /oldroot/dev/pts/@{int} -> /newroot/dev/console,
  mount               options=(rw silent rprivate)                          -> /oldroot/,
  mount               options=(rw silent rslave)                            -> /,
  mount fstype=devpts options=(rw nosuid noexec)                     devpts -> /newroot/dev/pts/,
  mount fstype=tmpfs  options=(rw nosuid nodev)                       tmpfs -> /newroot/dev/,
  mount fstype=tmpfs  options=(rw nosuid nodev)                       tmpfs -> /tmp/,

  remount options=(ro nosuid nodev bind silent relatime)         /newroot/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{HOME}/**/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{PROC}/sys/fs/binfmt_misc/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{run}/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{run}/user/@{uid}/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{run}/user/@{uid}/doc/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{run}/user/@{uid}/gvfs/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/@{sys}/fs/cgroup/net_cls/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/dev/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/dev/hugepages/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/efi/, 
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/tmp/,
  remount options=(ro nosuid nodev bind silent relatime)         /newroot/var/,
  remount options=(ro nosuid nodev bind silent)                  /newroot/dev/,
  remount options=(ro nosuid nodev bind silent)                  /newroot/dev/shm/,
  remount options=(ro nosuid nodev bind silent)                  /newroot/tmp/,
  remount options=(ro nosuid nodev noatime bind silent)          /newroot/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{PROC}/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/firmware/efi/efivars/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/fs/bpf/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/fs/cgroup/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/fs/fuse/connections/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/fs/pstore/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/kernel/config/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/kernel/debug/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/kernel/security/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/@{sys}/kernel/tracing/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/boot/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/dev/mqueue/,
  remount options=(ro nosuid nodev noexec bind silent relatime)  /newroot/dev/pts/,
  remount options=(ro nosuid nodev noexec bind silent)           /newroot/@{run}/,
  remount options=(ro nosuid nodev noexec noatime bind silent)   /newroot/@{HOME}/{,**/},
  remount options=(ro nosuid nodev noexec noatime bind silent)   /newroot/@{MOUNTS}/{,**/},

  umount /,
  umount /oldroot/,

  pivot_root oldroot=/newroot/ /newroot/,
  pivot_root oldroot=/tmp/oldroot/ /tmp/,

  owner / r,
  owner /newroot/**/ w,
  owner /newroot/dev/* w,

  owner /tmp/newroot/ w,
  owner /tmp/oldroot/ w,

  @{sys}/fs/cgroup/user.slice/cpu.max r,
  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/cpu.max r,
  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/cpu.max r,
  @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/cpu.max r,

        @{PROC}/sys/kernel/overflowgid r,
        @{PROC}/sys/kernel/overflowuid r,
        @{PROC}/sys/user/max_user_namespaces r,
  owner @{PROC}/@{pid}/cgroup r,
  owner @{PROC}/@{pid}/fd/ r,
  owner @{PROC}/@{pid}/gid_map rw,
  owner @{PROC}/@{pid}/mountinfo r,
  owner @{PROC}/@{pid}/setgroups rw,
  owner @{PROC}/@{pid}/uid_map rw,

  include if exists <abstractions/bwrap.d>
